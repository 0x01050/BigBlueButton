<?xml version="1.0" encoding="utf-8"?>

<!--
BigBlueButton open source conferencing system - http://www.bigbluebutton.org

Copyright (c) 2010 BigBlueButton Inc. and by respective authors (see below).

BigBlueButton is free software; you can redistribute it and/or modify it under the 
terms of the GNU Lesser General Public License as published by the Free Software 
Foundation; either version 2.1 of the License, or (at your option) any later 
version. 

BigBlueButton is distributed in the hope that it will be useful, but WITHOUT ANY 
WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A 
PARTICULAR PURPOSE. See the GNU Lesser General Public License for more details.

You should have received a copy of the GNU Lesser General Public License along 
with BigBlueButton; if not, see <http://www.gnu.org/licenses/>.

$Id: $
-->

<mx:HBox xmlns:mx="library://ns.adobe.com/flex/mx"
         xmlns:fx="http://ns.adobe.com/mxml/2009"
         xmlns:mate="http://mate.asfusion.com/"
         creationComplete="onCreationComplete()"
         verticalScrollPolicy="off" horizontalScrollPolicy="off"
         verticalAlign="middle"
         horizontalGap="8"
         horizontalAlign="center">
  
  <fx:Declarations>
    <mate:Listener type="{UsersRollEvent.USER_ROLL_OVER}" method="onRollOver" />
    <mate:Listener type="{UsersRollEvent.USER_ROLL_OUT}" method="onRollOut" />
    <mate:Listener type="{LocaleChangeEvent.LOCALE_CHANGED}" method="localeChanged" />
    <mate:Listener type="{ChangeMyRole.CHANGE_MY_ROLE_EVENT}" method="onChangeMyRole" />
  </fx:Declarations>
  
  <fx:Script>
    <![CDATA[
      import mx.binding.utils.ChangeWatcher;
      import mx.events.FlexEvent;
      import org.bigbluebutton.common.Images;
      import org.bigbluebutton.common.Role;
      import org.bigbluebutton.common.events.LocaleChangeEvent;
      import org.bigbluebutton.core.UsersUtil;
      import org.bigbluebutton.main.model.users.events.ChangeMyRole;
      import org.bigbluebutton.main.model.users.events.RoleChangeEvent;
      import org.bigbluebutton.modules.users.events.UsersRollEvent;
      private var images:Images = new Images();
      private var rolledOver:Boolean = false;
      private var moderator:Boolean = false;
      
      private function onCreationComplete():void {
        refreshRole(UsersUtil.amIModerator());
        
        // The next two lines should be listening for the same data to change and be updating at the same 
        // time, but the FlexEvent.DATA_CHANGE wasn't working consistently.
        this.addEventListener(FlexEvent.DATA_CHANGE, dataChangeHandler);
        ChangeWatcher.watch(this, "data", dataChangeHandler);
        
        if (data != null) // if data has already been set
          updateButtons(); //initialize state
        
        validateNow();
      }
      
      private function dataChangeHandler(e:Event):void {
        if (data != null) {
          updateButtons(); //reassess data state on change
        }
      }
      
      private function updateButtons(unneeded:Object = null):void {
        if (data != null) {

        }
      }
      
     
      private function onRollOver(e:UsersRollEvent):void{
        if (moderator && (e.userID == data.userId)) {
          rolledOver = true;
          updateButtons();
        }
      }
      
      private function onRollOut(e:UsersRollEvent):void{
        if (moderator && rolledOver) {
          rolledOver = false;
          updateButtons();
        }
      }
      
      private function onChangeMyRole(e:ChangeMyRole):void {
        rolledOver = false;
        updateButtons();
        
        refreshRole(e.role == Role.MODERATOR);
      }
      
      private function refreshRole(amIModerator:Boolean):void {
        moderator = amIModerator;
      }
      
      private function roleBtnClicked():void {
        if (!data.presenter) {
          var e:RoleChangeEvent = new RoleChangeEvent(RoleChangeEvent.ASSIGN_PRESENTER);
          e.userid = data.userId;
          e.username = data.name;
          dispatchEvent(e);
        }
      }
      

      
      // Need to refresh the roleBtn toolTip text on locale change
      private function localeChanged(e:Event):void {
        updateButtons();
      }
    ]]>
  </fx:Script>

  <mx:Button id="callingWith" visible="false" enabled="false" width="20" height="20" />
</mx:HBox>
