<?xml version="1.0" encoding="utf-8"?>

<!--
BigBlueButton open source conferencing system - http://www.bigbluebutton.org
Copyright (c) 2010 BigBlueButton Inc. and by respective authors (see below).
BigBlueButton is free software; you can redistribute it and/or modify it under the
terms of the GNU Lesser General Public License as published by the Free Software
Foundation; either version 2.1 of the License, or (at your option) any later
version.
BigBlueButton is distributed in the hope that it will be useful, but WITHOUT ANY
WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A
PARTICULAR PURPOSE. See the GNU Lesser General Public License for more details.
You should have received a copy of the GNU Lesser General Public License along
with BigBlueButton; if not, see <http://www.gnu.org/licenses/>.
$Id: $
-->

<!--
Notes.mxml is the main view of the SharedNotes application
-->
<MDIWindow xmlns="flexlib.mdi.containers.*"
        xmlns:mx="http://www.adobe.com/2006/mxml"
		width="510" height="600"
		xmlns:mate="http://mate.asfusion.com/"
		implements="org.bigbluebutton.common.IBbbModuleWindow"
		initialize="init()"
		creationComplete="onCreationComplete()"
		label="Create Poll" layout="absolute"
		title="{ResourceUtil.getInstance().getString('bbb.polling.createPoll')}">

	<mx:Script>
		<![CDATA[
		import flexlib.mdi.events.MDIWindowEvent;
		import org.bigbluebutton.main.views.MainCanvas;
		import mx.controls.Alert;
		import org.bigbluebutton.common.LogUtil;
		import mx.validators.Validator;
		import mx.utils.ObjectUtil;
		import mx.utils.StringUtil;	
		import mx.collections.ArrayCollection;
		import mx.core.IUIComponent;
		import mx.containers.HBox;
		import mx.controls.Text;
		import mx.controls.CheckBox;
		import mx.controls.RadioButton;
		import org.bigbluebutton.modules.polling.events.SavePollEvent;
		import org.bigbluebutton.modules.polling.events.PublishPollEvent;
		import org.bigbluebutton.modules.polling.managers.PollingManager;
		import org.bigbluebutton.modules.polling.events.PollingInstructionsWindowEvent;
		import org.bigbluebutton.modules.polling.events.StartPollingEvent;
		import org.bigbluebutton.modules.polling.events.PollingStatusCheckEvent;
		import org.bigbluebutton.modules.polling.events.PollGetTitlesEvent;
		import org.bigbluebutton.modules.polling.events.GenerateWebKeyEvent;
		import org.bigbluebutton.main.events.ShortcutEvent;
		
		import org.bigbluebutton.modules.polling.model.PollObject;
		import org.bigbluebutton.modules.polling.model.PollOptions;
		
		import org.bigbluebutton.core.managers.UserManager;
		import org.bigbluebutton.main.model.users.Conference 
		import org.bigbluebutton.main.model.users.BBBUser;
		import org.bigbluebutton.common.Role;
		
		import org.bigbluebutton.util.i18n.ResourceUtil;
		
		public static const LOGNAME:String = "[PollingInstructionsWindow] ";
		public var moduleAttributes:Object = new Object();
		private var userName:String;
		private var module:PollingModule;
		
		private var published:Boolean;
		
		[Bindable] public var participants:int;

		// Bindable is set to allow data to change when You hit Back and change something, this change will appear in review
		private var conference:Conference;
		[Bindable]private var _title:String;
		[Bindable]private var _question:String;
		[Bindable]private var _answers:ArrayCollection;
		[Bindable]private var _isMultiple:Boolean =false;
		[Bindable] public var _publishToWeb:Boolean;
		public var _webKey:String;
		private var _answersArray:Array;
		public var publishingAllowed:Boolean = true;
		private var manager:PollingManager = new PollingManager();
		[Bindable] public var invalidTitles:Array;
		[Bindable] public var incomingPoll:PollObject;
		[Bindable] public var editing:Boolean;
		[Bindable] public var pollOptions:PollOptions;
		[Bindable] private var baseIndex:int;
		
		// LENGTH CONSTRAINTS ( CHANGE IF YOU NEED)
		//################################################
		[Bindable]private var _MAX_QUESTION_LENGTH:uint = 200;
		[Bindable]private var _MAX_TITLE_LENGTH:uint=50;
		[Bindable]private var _MAX_ANSWER_LENGTH:uint = 100;
		[Bindable]private var _MAX_ANSWERS_AMOUNT:uint = 10;
		[Bindable]private var _ANSWER_CHARS_PER_LINE:uint=28; // made to avoid scrollbars (can be changed )
		//###############################################
		
		public function getPrefferedPosition():String{
			return MainCanvas.POPUP;
		}
			
		private function init():void{
			pollOptions = new PollOptions();
			baseIndex = pollOptions.baseTabIndex;
		}
		
		private function onCreationComplete():void{
			published = false;
			
			titleBarOverlay.tabIndex = baseIndex;
			minimizeBtn.tabIndex = baseIndex+1;
			maximizeRestoreBtn.tabIndex = baseIndex+2;
			closeBtn.tabIndex = baseIndex+3;
			titleBarOverlay.accessibilityName = ResourceUtil.getInstance().getString('bbb.polling.createPoll.accessTitle');
			
			if (incomingPoll != null){
				LogUtil.debug("EDITING POLL");
				pollTitle.text = incomingPoll.title;
				pollQuestion.text = incomingPoll.question;		
				for (var i:int = 0; i < incomingPoll.answers.length; i++){
					pollAnswers.text += incomingPoll.answers[i];
					if (i < incomingPoll.answers.length-1){
						pollAnswers.text += "\n";
					}
				}  
				multiple_response.selected = incomingPoll.isMultiple;
				isMultiple();
			}else{
				editing = false;
			}
			
			userName = moduleAttributes.username;
			
			this.module = module;
			focusManager.setFocus(titleBarOverlay); 
		}
		
		// Overwritting close to use custom function
		override public function close(event:MouseEvent = null):void {
			closeInstructionsWindow();
		}
		
		// function invoked when close window
		private function closeInstructionsWindow():void {
			dispatchEvent(new PollingInstructionsWindowEvent(PollingInstructionsWindowEvent.CLOSE));
		}
		
		// function invoked when checkbox is checked
		private function isMultiple():void{
			if(multiple_response.selected == true)
				_isMultiple= true;
			else
				_isMultiple= false;
		}
			
		// DATA VALIDATION
		//##################################################################################
		private function validateAndSubmit():void {
			var valid:Boolean = true;
			allowPublishing();
		}
			
		// ANSWER VALIDATION
		private function answerError():String{
			var errMsg:String = "VALID";
			var answersArray:Array;
			var valid:Boolean=true;
			answersArray = pollAnswers.text.split("\r"); 
// splitting by '*' and new line, thus user can type '*' anywhere except the newline
			//answersArray[0] = answersArray[0].split('*').join(''); 
// As after split '*' is not displayed we need to take off from first element which is not splitted
			answersArray = makeAnswersPretty(answersArray);
			// ALL THE MESSAGES NEED TO BE LOCALISED!!!!!
			if (pollAnswers.length == 0 )
				errMsg = ResourceUtil.getInstance().getString('bbb.polling.validation.atLeast2Answers');
			else if (isDuplicateAnswers(answersArray))
				errMsg = ResourceUtil.getInstance().getString('bbb.polling.validation.answerUnique');
			else if(answersArray.length < 2)
				errMsg = ResourceUtil.getInstance().getString('bbb.polling.validation.eachNewLine');
			else if(answersArray.length > _MAX_ANSWERS_AMOUNT)
				errMsg = ResourceUtil.getInstance().getString('bbb.polling.validation.toomuchAnswers') +" "+_MAX_ANSWERS_AMOUNT;
			else {
				for (var i:int=0; i< answersArray.length; i++){
					if(i != 0 && (answersArray[i] == null || answersArray[i] == "")){
						answersArray.splice(i,1);
					}else if(answersArray[i].length > _MAX_ANSWER_LENGTH){
						errMsg = ResourceUtil.getInstance().getString('bbb.polling.validation.toolongAnswer') +" "+_MAX_ANSWER_LENGTH;
						valid=false;
					}
					// if last character of the array element is return (new line) or space, we it to have accurate string and than checking for duplicates again
			
					if(valid && !isDuplicateAnswers(answersArray)){
						_answers = new ArrayCollection(answersArray); // This will be displayed in Preview
						_answersArray= answersArray; // this will be sent to server
					}
				}
			}
			return errMsg;
		}
		
		//#####################################################################################################
		
		public function goBack():void{
			back.visible=false;
			focusTitle();
		}
		
		private function isDuplicateAnswers(arr:Array):Boolean{
			var x:uint;
			var y:uint;
			for (x = 0; x < arr.length ; x++){
				for (y = x + 1; y < arr.length; y++){
					if (arr[x] === arr[y]){
						return true;
					}
				}
			}
			return false;
		}
		
		//trimming return and whitespaces at the end of each array element
		private function makeAnswersPretty(arr:Array):Array{
			var i:uint;
			var trim:RegExp = /^\s+|\s+$/g;
			for (i = 0; i < arr.length; i++){
				arr[i] = arr[i].replace(trim, "");
				if(!arr[i]) //if user puts just return or space and return - this array elements will be deleted
					arr.splice(i,1);
				}
			return arr;
		}
		
		private function formatAndReview():void{

		}
		
		private function upperFirstLetter(str:String) : String {
			return str.substr(0, 1).toUpperCase() + str.substr(1, str.length);
		}

		// function receives Array.length and ArrayCollectionvar p:BBBUser;
		private function createButtons(amount:uint, content:ArrayCollection):void{
			var _cb:CheckBox;
			var _rb:RadioButton;
			var _tx: Text;
			var _hb: HBox;
			var totalOptions:int = content.length; 
			// creating buttons one by one
			for (var i:int = 0; i < amount; i++) {
				var indicator:String = ResourceUtil.getInstance().getString('bbb.polling.vote.indicator', [i+1, totalOptions]);
				_tx = new Text();
				_hb = new HBox();
				_tx.name = "option" +i;
				_tx.width = 200;
				// assigning array element to text field
				_tx.text =content.getItemAt(i).toString();

				// if global var _isMultiple is true it means user wants checkboxes,
				//otherwise radiobutton (if multiple choices are allowed)
				if(_isMultiple){
					_cb= new CheckBox();
					// giving button a name of array elelment to process it easier later
					_cb.name=content.getItemAt(i).toString();
					_cb.accessibilityName = indicator + content.getItemAt(i).toString();
					_cb.tabIndex = baseIndex + 5 + i
					// gap between the buttons
					_cb.y=i*20;
					// adding buttons to the Horizontal Box
					_hb.addChild(_cb);
				}else{
					_rb = new RadioButton();
					_rb.name = content.getItemAt(i).toString(); // giving button a name of array elelment to process it easier later
					_rb.groupName = "answers";
					_rb.label =" ";
					_rb.tabIndex = baseIndex + 5;
					_hb.addChild(_rb);
				}
			_hb.addChild(_tx); // adding text near button
			} // end of loop
		} // end of function
		
		private function buildPoll():PollObject{
			var builtPoll:PollObject = new PollObject();
			builtPoll.title = _title;
			builtPoll.isMultiple = _isMultiple;
			builtPoll.question = _question;
			builtPoll.answers = _answersArray;
			builtPoll.didNotVote = participants;
			builtPoll.publishToWeb = _publishToWeb;
			if (_publishToWeb && _webKey != null)
				builtPoll.webKey = _webKey;
			return builtPoll;
		}
		
		private function savePoll(callingFromPublish:Boolean = false):void {
			participants = 0;
			var p:BBBUser;
			conference = UserManager.getInstance().getConference();
			for (var i:int = 0; i < conference.users.length; i++) {
				p = conference.users.getItemAt(i) as BBBUser;
				if (p.role != Role.MODERATOR) {
					participants++;
				}
			} 
			
			var savePollEvent: SavePollEvent = new SavePollEvent(SavePollEvent.SAVE);
			savePollEvent.poll = buildPoll();
			savePollEvent.poll.status = !callingFromPublish;
			
			dispatchEvent(savePollEvent);
			if(!callingFromPublish)
				closeInstructionsWindow();
		}
		
		private function publish():void {
			published = true;
			savePoll(true);
			
			var publishPollEvent: PublishPollEvent = new PublishPollEvent(PublishPollEvent.PUBLISH);
			publishPollEvent.poll = buildPoll();
			publishPollEvent.poll.webKey = _webKey;
			dispatchEvent(publishPollEvent);
			
			dispatchEvent(new StartPollingEvent(StartPollingEvent.START));
			closeInstructionsWindow();
		}
		
		private function allowPublishing():void {
			dispatchEvent(new PollingStatusCheckEvent(PollingStatusCheckEvent.CHECK));
		}
			
		private function focusTitle(e:ShortcutEvent = null):void{
			if (pollTitle.enabled && pollTitle.visible){
				focusManager.setFocus(pollTitle);
			}
		}
		]]>
	</mx:Script>
  <mx:VBox width="100%" height="100%">
      <mx:VBox width="100%" height="90%" focusEnabled="true">
        <mx:Form width="100%" id="instructionsForm" paddingTop="30" paddingBottom="10" paddingLeft="30" focusEnabled="true">
          <mx:FormItem fontWeight="bold" paddingLeft="35" id="titleFormItem" focusEnabled="true"
                       label="{ResourceUtil.getInstance().getString('bbb.polling.createPoll.title')}" >
            <mx:TextInput id="pollTitle" focusEnabled="true" tabIndex="{baseIndex+4}" maxChars="75"
                          accessibilityDescription="{ResourceUtil.getInstance().getString('bbb.polling.createPoll.title')}"
                          />
          </mx:FormItem>
          
          <mx:FormItem fontWeight="bold" 
                       label="{ResourceUtil.getInstance().getString('bbb.polling.createPoll.question')}" 
                       paddingLeft="35" 
                       paddingTop="20" >
            <mx:TextArea id="pollQuestion" maxChars="200"
                         width="200" height="100" 
                         accessibilityDescription="{ResourceUtil.getInstance().getString('bbb.polling.createPoll.question')}"
                         tabIndex="{baseIndex+4}"/>
          </mx:FormItem>
          
          <mx:FormItem fontWeight="bold" paddingLeft="35" paddingTop="30"
                       label="{ResourceUtil.getInstance().getString('bbb.polling.createPoll.answers')}" >
            <mx:TextArea id="pollAnswers" width="200" height="100" tabIndex="{baseIndex+4}"
                        accessibilityDescription="{ResourceUtil.getInstance().getString('bbb.polling.createPoll.answers')}"/>
            <mx:Label id="answerHint" visible="true" width="100%" fontSize="9" fontWeight="normal"
                      text="{ResourceUtil.getInstance().getString('bbb.polling.createPoll.hint')}" />
          </mx:FormItem>
                    
          <mx:FormItem paddingLeft="10" paddingTop="5" >
            <mx:CheckBox id="multiple_response" 
                         label="{ResourceUtil.getInstance().getString('bbb.polling.createPoll.moreThanOneResponse')}" 
                         click="isMultiple()" tabIndex="{baseIndex+4}"/>
          </mx:FormItem>
        </mx:Form>
      </mx:VBox>
    
    <mx:ControlBar>
      <mx:Button id="back" click="goBack()" width="100" height="30" visible="true" tabIndex="{baseIndex+5}"
                 label="{ResourceUtil.getInstance().getString('bbb.polling.pollPreview.modify')}" />
      <mx:Button id="Cancel" click="closeInstructionsWindow()" width="100" height="30" tabIndex="{baseIndex+5}"
                 label="{ResourceUtil.getInstance().getString('bbb.polling.pollPreview.cancel')}" />
    </mx:ControlBar>    
  </mx:VBox>	

</MDIWindow>
