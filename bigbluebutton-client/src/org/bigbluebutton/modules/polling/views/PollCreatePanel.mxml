<?xml version="1.0" encoding="utf-8"?>
<mx:Panel xmlns:mx="http://www.adobe.com/2006/mxml">
  <mx:Script>
      <![CDATA[
        import org.bigbluebutton.modules.polling.events.CreatePollEvent;
        import org.bigbluebutton.modules.polling.vo.CreatePollVO;
        import org.bigbluebutton.modules.polling.vo.CreateQuestionVO;
        import org.bigbluebutton.util.i18n.ResourceUtil;
        
        [Bindable] private var baseIndex:int;
        
        public function createPoll():void {
          var answersArray:Array;
          var valid:Boolean=true;
          answersArray = pollAnswers.text.split("\r"); 
          // splitting by '*' and new line, thus user can type '*' anywhere except the newline
          //answersArray[0] = answersArray[0].split('*').join(''); 
          // As after split '*' is not displayed we need to take off from first element which is not splitted
          answersArray = makeAnswersPretty(answersArray);
          
          var createPollVO:CreatePollVO = new CreatePollVO(pollTitle.text);
          var questionType:String = "MULTI_CHOICE";
          if ( multiple_response.selected) {
            questionType = "MULTI_RESPONSE";
          }
          var question:CreateQuestionVO = new CreateQuestionVO(questionType, pollQuestion.text);
          for (var i:int = 0; i < answersArray.length; i++) {
            question.addResponse(answersArray[i] as String);
          }
          
          createPollVO.addQuestion(question);
          
          dispatchEvent(new CreatePollEvent(createPollVO));
        }
        
        private function isDuplicateAnswers(arr:Array):Boolean{
          var x:uint;
          var y:uint;
          for (x = 0; x < arr.length ; x++){
            for (y = x + 1; y < arr.length; y++){
              if (arr[x] === arr[y]){
                return true;
              }
            }
          }
          return false;
        }
        
        //trimming return and whitespaces at the end of each array element
        private function makeAnswersPretty(arr:Array):Array{
          var i:uint;
          var trim:RegExp = /^\s+|\s+$/g;
          for (i = 0; i < arr.length; i++){
            arr[i] = arr[i].replace(trim, "");
            if(!arr[i]) //if user puts just return or space and return - this array elements will be deleted
              arr.splice(i,1);
          }
          return arr;
        }
        
      ]]>    
  </mx:Script>
  
  <mx:VBox width="100%" height="100%">
    <mx:VBox width="100%" height="90%" focusEnabled="true">
      <mx:Form width="100%" id="instructionsForm" paddingTop="30" paddingBottom="10" paddingLeft="30" focusEnabled="true">
        <mx:FormItem fontWeight="bold" paddingLeft="35" id="titleFormItem" focusEnabled="true"
                     label="{ResourceUtil.getInstance().getString('bbb.polling.createPoll.title')}" >
          <mx:TextInput id="pollTitle" focusEnabled="true" tabIndex="{baseIndex+4}" maxChars="75"
                        accessibilityDescription="{ResourceUtil.getInstance().getString('bbb.polling.createPoll.title')}"/>
        </mx:FormItem>
        
        <mx:FormItem fontWeight="bold" 
                     label="{ResourceUtil.getInstance().getString('bbb.polling.createPoll.question')}" 
                     paddingLeft="35" 
                     paddingTop="20" >
          <mx:TextArea id="pollQuestion" maxChars="200"
                       width="200" height="100" 
                       accessibilityDescription="{ResourceUtil.getInstance().getString('bbb.polling.createPoll.question')}"
                       tabIndex="{baseIndex+4}"/>
        </mx:FormItem>
        
        <mx:FormItem fontWeight="bold" paddingLeft="35" paddingTop="30"
                     label="{ResourceUtil.getInstance().getString('bbb.polling.createPoll.answers')}" >
          <mx:Label id="answerHint" visible="true" width="100%" fontSize="9" fontWeight="normal"
                    text="{ResourceUtil.getInstance().getString('bbb.polling.createPoll.hint')}" />
          <mx:TextArea id="pollAnswers" width="200" height="100" tabIndex="{baseIndex+4}"
                       accessibilityDescription="{ResourceUtil.getInstance().getString('bbb.polling.createPoll.answers')}"/>
        </mx:FormItem>
        
        <mx:FormItem paddingLeft="10" paddingTop="5" >
          <mx:CheckBox id="multiple_response" 
                       label="{ResourceUtil.getInstance().getString('bbb.polling.createPoll.moreThanOneResponse')}" 
                       tabIndex="{baseIndex+4}"/>
        </mx:FormItem>
      </mx:Form>
    </mx:VBox>
    
    <mx:ControlBar>
      <mx:Button id="createBtn" click="" width="100" height="30" tabIndex="{baseIndex+5}"
                 label="Create" />
      <mx:Button id="Cancel" click="" width="100" height="30" tabIndex="{baseIndex+5}"
                 label="{ResourceUtil.getInstance().getString('bbb.polling.pollPreview.cancel')}" />
    </mx:ControlBar>    
  </mx:VBox>
</mx:Panel>
